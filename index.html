<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sundorica - Your Fashion Destination</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@700&family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Roboto', sans-serif; background-color: #f7fafc; }
        .font-orbitron { font-family: 'Orbitron', sans-serif; }
        .footer-hidden { opacity: 0; transition: opacity 1.5s ease; }
        .footer-visible { opacity: 1; }
        .thumbnail-container::-webkit-scrollbar { display: none; }
        .thumbnail-container { -ms-overflow-style: none; scrollbar-width: none; }
        .thumbnail-img { border: 2px solid transparent; transition: border-color 0.2s ease; }
        .thumbnail-img.active { border-color: #0d9488; }
        input[type="number"]::-webkit-inner-spin-button, 
        input[type="number"]::-webkit-outer-spin-button { -webkit-appearance: none; margin: 0; }
        input[type="number"] { -moz-appearance: textfield; }
        #global-loader {
            position: fixed;
            inset: 0;
            background-color: rgba(255, 255, 255, 0.8);
            z-index: 9999;
            display: flex;
            align-items: center;
            justify-content: center;
        }
    </style>
</head>
<body class="text-gray-800">

    <!-- Global Loader -->
    <div id="global-loader">
        <svg class="animate-spin h-10 w-10 text-teal-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
        </svg>
    </div>

    <!-- Header -->
    <header id="page-header" class="bg-white shadow-md sticky top-0 z-40">
        <nav class="container mx-auto px-4 sm:px-6 h-20 flex items-center">
            <a href="#home" onclick="handleNav(event, '#home')" class="text-3xl font-orbitron font-bold text-black">Sundorica</a>
            <div class="flex-grow"></div>
            <div class="hidden md:flex items-center space-x-4" id="desktop-menu-container">
                <!-- Menu will be dynamically inserted here -->
            </div>
            <div class="flex-grow"></div>
            <div class="flex items-center space-x-4">
                <a href="#cart" onclick="handleNav(event, '#cart')" class="relative text-gray-600 hover:text-teal-500"><svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 3h2l.4 2M7 13h10l4-8H5.4M7 13L5.4 5M7 13l-2.293 2.293c-.63.63-.184 1.707.707 1.707H17m0 0a2 2 0 100 4 2 2 0 000-4zm-8 2a2 2 0 11-4 0 2 2 0 014 0z"></path></svg><span id="cart-count" class="absolute -top-2 -right-2 bg-teal-500 text-white text-xs rounded-full h-5 w-5 flex items-center justify-center">0</span></a>
                <button id="mobile-menu-button" class="md:hidden text-gray-600"><svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16m-7 6h7"></path></svg></button>
            </div>
        </nav>
        <div id="mobile-menu" class="hidden md:hidden bg-white">
            <!-- Mobile menu will be dynamically inserted here -->
        </div>
    </header>

    <!-- Main Content Area -->
    <div id="app-content">
        <main id="home-view" class="hidden container mx-auto px-4 sm:px-6 py-12"><h1 id="page-title" class="text-3xl font-bold text-center mb-10">All Products</h1><div id="product-grid" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4 md:gap-8"></div></main>
        <main id="product-view" class="hidden container mx-auto px-4 sm:px-6 py-12"><div class="mb-6"><a href="#" onclick="handleNav(event, '#home')" class="text-teal-600 hover:underline">&larr; Back to all products</a></div><div class="grid grid-cols-1 md:grid-cols-2 gap-8 md:gap-12"><div class="flex flex-col-reverse md:flex-row gap-4"><div id="thumbnail-container" class="thumbnail-container flex md:flex-col gap-2 overflow-x-auto md:overflow-x-hidden md:h-[500px] lg:h-[600px]"></div><div class="relative flex-1"><img id="main-product-image" src="" alt="Product" class="w-full h-auto object-contain rounded-lg shadow-md cursor-pointer"></div></div><div class="w-full"><h1 id="product-page-title" class="text-3xl md:text-4xl font-bold mb-2"></h1><div id="product-page-price" class="flex items-baseline space-x-3 mb-6"></div><div id="size-section" class="mb-6 hidden"><h3 class="font-semibold mb-3 text-lg">Size:</h3><div id="size-options" class="flex flex-wrap gap-3"></div></div><div class="space-y-4 mt-6"><button id="add-to-cart-btn" class="w-full bg-teal-500 text-white py-3 rounded-lg font-semibold text-lg hover:bg-teal-600 transition duration-300">Add to Cart</button><button id="buy-now-btn" class="w-full bg-gray-800 text-white py-3 rounded-lg font-semibold text-lg hover:bg-black transition duration-300">Buy It Now</button></div><div class="mt-8"><h3 class="font-semibold text-xl mb-2 border-b pb-2">Description</h3><div id="product-page-desc" class="text-base text-gray-600 mt-4 leading-relaxed prose"></div></div></div></div></main>
        <main id="cart-view" class="hidden container mx-auto px-4 sm:px-6 py-12"><h1 class="text-3xl font-bold text-center mb-10">Your Shopping Cart</h1><div id="cart-items-container" class="bg-white p-6 rounded-lg shadow-md"></div></main>
        <main id="checkout-view" class="hidden container mx-auto px-4 sm:px-6 py-12"><h1 class="text-3xl font-bold text-center mb-10">Checkout</h1><div class="grid grid-cols-1 lg:grid-cols-2 gap-12"><div class="bg-white p-8 rounded-lg shadow-md"><h2 class="text-2xl font-semibold mb-6">Shipping Information</h2><form id="checkout-form" class="space-y-4"><div><label for="name" class="block text-sm font-medium">Name</label><input type="text" id="name" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-teal-500 focus:ring-teal-500"></div><div><label for="phone" class="block text-sm font-medium">Phone Number</label><input type="tel" id="phone" required pattern="\d{11}" title="Please enter an 11-digit phone number" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-teal-500 focus:ring-teal-500"></div><div><label for="address" class="block text-sm font-medium">Address</label><textarea id="address" rows="3" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-teal-500 focus:ring-teal-500"></textarea></div><div><label for="delivery-zone" class="block text-sm font-medium">Delivery Zone</label><select id="delivery-zone" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-teal-500 focus:ring-teal-500"></select></div></form></div><div class="bg-white p-8 rounded-lg shadow-md"><h2 class="text-2xl font-semibold mb-6">Order Summary</h2><div id="checkout-summary-items" class="space-y-4"></div><div class="border-t mt-6 pt-6 space-y-3"><div class="flex justify-between text-lg"><p>Subtotal</p><p id="summary-subtotal">৳0</p></div><div class="flex justify-between text-lg"><p>Shipping</p><p id="summary-shipping">৳0</p></div><div class="flex justify-between font-bold text-xl"><p>Total</p><p id="summary-total">৳0</p></div></div><button id="complete-order-btn" type="submit" form="checkout-form" class="w-full mt-8 bg-teal-500 text-white py-3 rounded-lg font-semibold text-lg hover:bg-teal-600 transition duration-300 flex items-center justify-center disabled:opacity-50"><span class="btn-text">Complete Order</span><svg class="animate-spin h-5 w-5 ml-3 hidden btn-loader" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg></button></div></div></main>
    </div>
    
    <!-- Footer -->
    <footer id="footer" class="bg-gray-800 text-white py-6 footer-hidden mt-16"><div class="container mx-auto px-6 text-center"><div class="flex justify-center space-x-6 mb-4"><a href="https://www.facebook.com/Sundorica" target="_blank" class="hover:text-teal-400 transition-colors"><svg class="w-6 h-6" fill="currentColor" viewBox="0 0 24 24"><path d="M22.675 0h-21.35c-.732 0-1.325.593-1.325 1.325v21.351c0 .731.593 1.324 1.325 1.324h11.495v-9.294h-3.128v-3.622h3.128v-2.671c0-3.1 1.893-4.788 4.659-4.788 1.325 0 2.463.099 2.795.143v3.24l-1.918.001c-1.504 0-1.795.715-1.795 1.763v2.313h3.587l-.467 3.622h-3.12v9.293h6.116c.73 0 1.323-.593 1.323-1.325v-21.35c0-.732-.593-1.325-1.323-1.325z"/></svg></a><a href="https://www.instagram.com/sundorica.store" target="_blank" class="hover:text-teal-400 transition-colors"><svg class="w-6 h-6" fill="currentColor" viewBox="0 0 24 24"><path d="M12 2.163c3.204 0 3.584.012 4.85.07 3.252.148 4.771 1.691 4.919 4.919.058 1.265.069 1.645.069 4.85s-.011 3.584-.069 4.85c-.149 3.225-1.664 4.771-4.919 4.919-1.266.058-1.644.07-4.85.07s-3.584-.012-4.85-.07c-3.252-.148-4.771-1.691-4.919-4.919-.058-1.265-.069-1.645-.069-4.85s.011-3.584.069-4.85c.149-3.225 1.664-4.771 4.919-4.919 1.266-.058 1.644-.07 4.85-.07zm0-2.163c-3.259 0-3.667.014-4.947.072-4.358.2-6.78 2.618-6.98 6.98-.059 1.281-.073 1.689-.073 4.948s.014 3.667.072 4.947c.2 4.358 2.618 6.78 6.98 6.98 1.281.058 1.689.072 4.948.072s3.667-.014 4.947-.072c4.358-.2 6.78-2.618 6.98-6.98.059-1.281.073-1.689.073-4.948s-.014-3.667-.072-4.947c-.2-4.358-2.618-6.78-6.98-6.98-1.281-.059-1.689-.073-4.948-.073zm0 5.838c-3.403 0-6.162 2.759-6.162 6.162s2.759 6.162 6.162 6.162 6.162-2.759 6.162-6.162-2.759-6.162-6.162-6.162zm0 10.162c-2.209 0-4-1.79-4-4s1.791-4 4-4 4 1.79 4 4-1.791 4-4 4zm6.406-11.845c-.796 0-1.441.645-1.441 1.44s.645 1.44 1.441 1.44 1.441-.645 1.441-1.44-.645-1.44-1.441-1.44z"/></svg></a></div><p class="text-sm">&copy; 2024 Sundorica. All Rights Reserved.</p></div></footer>

    <!-- Lightbox Modal -->
    <div id="lightbox-modal" class="hidden fixed inset-0 bg-black bg-opacity-90 z-50 flex items-center justify-center p-4"><img id="lightbox-image" src="" alt="Full-screen product image" class="max-h-full max-w-full object-contain"><button id="lightbox-close" class="absolute top-5 right-5 text-white text-4xl font-bold">&times;</button><button id="lightbox-prev" class="absolute left-5 top-1/2 -translate-y-1/2 text-white text-4xl font-bold bg-black bg-opacity-40 p-2 rounded-full">&lt;</button><button id="lightbox-next" class="absolute right-5 top-1/2 -translate-y-1/2 text-white text-4xl font-bold bg-black bg-opacity-40 p-2 rounded-full">&gt;</button></div>
    
    <!-- Thank You Popup -->
    <div id="thank-you-modal" class="hidden fixed inset-0 bg-black bg-opacity-60 z-50 flex items-center justify-center p-4"><div class="bg-white rounded-lg shadow-xl w-full max-w-md p-8 text-center"><svg class="w-16 h-16 mx-auto text-green-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg><h2 class="text-2xl font-bold mt-4">Thank You!</h2><p class="text-gray-600 mt-2">Your order has been placed successfully.</p><div class="mt-6 text-left bg-gray-100 p-4 rounded-lg"><p class="text-sm">Order ID: <strong id="order-id-display" class="font-mono"></strong></p><p class="text-sm">Total Amount: <strong id="order-amount-display"></strong></p></div><button id="close-thank-you-modal" class="w-full mt-6 bg-teal-500 text-white py-2 rounded-lg font-semibold hover:bg-teal-600 transition">Continue Shopping</button></div></div>

    <!-- Simple Alert/Popup -->
    <div id="alert-popup" class="fixed top-5 right-5 bg-red-500 text-white py-2 px-4 rounded-lg shadow-lg hidden transform translate-x-full transition-transform duration-300 z-[70]"></div>

    <script>
    document.addEventListener('DOMContentLoaded', () => {
        const WEB_APP_URL = "https://script.google.com/macros/s/AKfycbxPaNt_z0uRscltA5lyE_WTPogNs5d1mCqd7JDREyzJqUTHi0OPQlnh85f3ySpMTU4/exec";
        
        let allProducts = [], cart = JSON.parse(localStorage.getItem('sundoricaCart')) || [], selectedProduct = null, selectedSize = null;

        const views = { home: document.getElementById('home-view'), product: document.getElementById('product-view'), cart: document.getElementById('cart-view'), checkout: document.getElementById('checkout-view') };
        const globalLoader = document.getElementById('global-loader');

        const fetchWithCache = async (url, cacheKey, expiryMinutes = 1) => {
            const cached = localStorage.getItem(cacheKey);
            if (cached) {
                const { timestamp, data } = JSON.parse(cached);
                if (Date.now() - timestamp < expiryMinutes * 60 * 1000) return data;
            }
            try {
                const response = await fetch(url);
                if (!response.ok) throw new Error(`Network error. Check deployment permissions.`);
                const result = await response.json();
                if (result.status !== 'success') throw new Error(result.message);
                localStorage.setItem(cacheKey, JSON.stringify({ timestamp: Date.now(), data: result.data }));
                return result.data;
            } catch (e) {
                console.error(`Fetch Error: ${e.message}`);
                throw new Error(`Could not load data. Ensure Apps Script is deployed for "Anyone".`);
            }
        };

        const initializeApp = async () => {
            try {
                const [products, deliveryCharges] = await Promise.all([
                    fetchWithCache(`${WEB_APP_URL}?action=getProducts`, 'sundoricaProducts', 5),
                    fetchWithCache(`${WEB_APP_URL}?action=getDeliveryCharges`, 'sundoricaDelivery', 60)
                ]);
                allProducts = products;
                renderCategories(products);
                renderDeliveryZones(deliveryCharges);
                updateCartCount();
                handleRouteChange();
            } catch (error) {
                showAlert(error.message);
            } finally {
                globalLoader.style.display = 'none';
                document.getElementById('footer').classList.add('footer-visible');
            }
        };

        const handleRouteChange = () => {
            const hash = window.location.hash || '#home';
            const [route, param] = hash.substring(1).split('/');
            Object.values(views).forEach(view => view.classList.add('hidden'));
            let productsToRender = allProducts, pageTitle = "All Products";
            if (route === 'category') { productsToRender = allProducts.filter(p => p.Category === param); pageTitle = param; }
            if (route === 'home' || route === 'category') { views.home.classList.remove('hidden'); renderProductGrid(productsToRender); document.getElementById('page-title').textContent = pageTitle; } 
            else if (route === 'product' && param) { selectedProduct = allProducts.find(p => p.SKU == param); if (selectedProduct) { views.product.classList.remove('hidden'); renderProductPage(selectedProduct); } else { window.location.hash = '#home'; } } 
            else if (route === 'cart') { views.cart.classList.remove('hidden'); renderCartPage(); } 
            else if (route === 'checkout') { views.checkout.classList.remove('hidden'); renderCheckoutPage(); } 
            else { views.home.classList.remove('hidden'); renderProductGrid(allProducts); }
            window.scrollTo(0, 0);
        };

        const renderProductGrid = (products) => {
            const grid = document.getElementById('product-grid');
            grid.innerHTML = (!products || products.length === 0) ? `<p class="col-span-full text-center text-gray-500">No products found.</p>` : products.map(p => `
                <a href="#product/${p.SKU}" class="bg-white rounded-lg shadow-lg overflow-hidden group block">
                    <div class="aspect-[2/3] bg-gray-200"><img src="${p.Images[0] || 'https://placehold.co/400x600/e2e8f0/333?text=No+Image'}" alt="${p.Name}" class="w-full h-full object-cover transition-transform duration-300 group-hover:scale-105"></div>
                    <div class="p-4"><h3 class="text-md font-semibold truncate">${p.Name}</h3><div class="flex items-baseline space-x-2 mt-2"><p class="text-lg font-bold text-teal-600">৳${p.Price.toLocaleString()}</p>${p['Compare-at price'] ? `<p class="text-sm text-red-500 line-through">৳${p['Compare-at price'].toLocaleString()}</p>` : ''}</div></div>
                </a>`).join('');
        };

        const renderProductPage = (product) => {
            document.getElementById('product-page-title').textContent = product.Name;
            document.getElementById('product-page-price').innerHTML = `<p class="text-3xl font-bold text-teal-600">৳${product.Price.toLocaleString()}</p>${product['Compare-at price'] ? `<p class="text-xl text-red-500 line-through">৳${product['Compare-at price'].toLocaleString()}</p>` : ''}`;
            document.getElementById('product-page-desc').innerHTML = product.Description.replace(/\n/g, '<br>');
            renderImageGallery(product.Images);
            const sizeSection = document.getElementById('size-section'), sizeOptions = document.getElementById('size-options');
            sizeSection.classList.add('hidden'); sizeOptions.innerHTML = ''; selectedSize = null;
            if (product.Sizes && product.Sizes.length > 0) {
                sizeSection.classList.remove('hidden');
                product.Sizes.forEach(s => {
                    if (s.quantity > 0) {
                        const btn = document.createElement('button');
                        btn.className = 'size-btn border-2 border-gray-300 rounded px-4 py-2 hover:border-teal-500 focus:border-teal-500 focus:ring-2 focus:ring-teal-200 transition';
                        btn.textContent = s.size;
                        btn.onclick = () => { sizeOptions.querySelectorAll('.size-btn').forEach(b => b.classList.remove('bg-teal-500', 'text-white', 'border-teal-500')); btn.classList.add('bg-teal-500', 'text-white', 'border-teal-500'); selectedSize = s.size; };
                        sizeOptions.appendChild(btn);
                    }
                });
            }
        };

        const renderCategories = (products) => {
            const allCategories = [...new Set(products.map(p => p.Category))].filter(Boolean);
            const clothingSubCategories = ['Stitched', 'Unstitched'];
            const otherCategories = allCategories.filter(cat => !clothingSubCategories.includes(cat));

            const desktopContainer = document.getElementById('desktop-menu-container');
            let desktopHTML = `<a href="#home" onclick="handleNav(event, '#home')" class="text-gray-600 hover:text-teal-500 transition duration-300">All Products</a>`;
            desktopHTML += `<div class="relative group"><button class="text-gray-600 hover:text-teal-500 transition duration-300 flex items-center">Clothing<svg class="w-4 h-4 ml-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg></button><div class="absolute hidden group-hover:block bg-white shadow-lg rounded-md mt-2 py-2 w-40 z-10"><a href="#category/Stitched" onclick="handleNav(event, '#category/Stitched')" class="block px-4 py-2 text-sm text-gray-700 hover:bg-teal-50">Stitched</a><a href="#category/Unstitched" onclick="handleNav(event, '#category/Unstitched')" class="block px-4 py-2 text-sm text-gray-700 hover:bg-teal-50">Unstitched</a></div></div>`;
            desktopHTML += otherCategories.map(cat => `<a href="#category/${cat}" onclick="handleNav(event, '#category/${cat}')" class="text-gray-600 hover:text-teal-500 transition duration-300">${cat}</a>`).join('');
            desktopContainer.innerHTML = desktopHTML;

            const mobileContainer = document.getElementById('mobile-menu');
            let mobileHTML = `<a href="#home" onclick="handleNav(event, '#home')" class="block py-2 px-6 text-sm hover:bg-teal-50">All Products</a>`;
            mobileHTML += `<div class="px-6 py-2 text-sm font-semibold text-gray-400">Clothing</div>`;
            mobileHTML += `<a href="#category/Stitched" onclick="handleNav(event, '#category/Stitched')" class="block py-2 pl-10 text-sm hover:bg-teal-50">Stitched</a>`;
            mobileHTML += `<a href="#category/Unstitched" onclick="handleNav(event, '#category/Unstitched')" class="block py-2 pl-10 text-sm hover:bg-teal-50">Unstitched</a>`;
            if (otherCategories.length > 0) {
                mobileHTML += `<div class="border-t my-2"></div>`;
                mobileHTML += otherCategories.map(cat => `<a href="#category/${cat}" onclick="handleNav(event, '#category/${cat}')" class="block py-2 px-6 text-sm hover:bg-teal-50">${cat}</a>`).join('');
            }
            mobileContainer.innerHTML = mobileHTML;
        };
        
        const renderDeliveryZones = (charges) => {
            const select = document.getElementById('delivery-zone');
            select.innerHTML = '<option value="">Select Zone</option>';
            charges.forEach(zone => {
                const option = document.createElement('option');
                option.value = `${zone.zoneName.toLowerCase().replace(/\s+/g, '-')}-${zone.charge}`;
                option.textContent = `${zone.zoneName} (৳${zone.charge})`;
                select.appendChild(option);
            });
        };

        const renderCartPage = () => {
            const container = document.getElementById('cart-items-container');
            updateCartCount();
            if (cart.length === 0) { container.innerHTML = `<div class="text-center text-gray-500 py-8">Your cart is empty. <a href="#home" class="text-teal-600 hover:underline">Continue shopping</a>.</div>`; return; }
            let itemsHTML = cart.map((item, index) => `<div class="flex items-center justify-between border-b py-4 gap-2"><div class="flex items-center gap-4 flex-1"><img src="${item.image}" alt="${item.name}" class="w-16 h-24 md:w-20 md:h-28 object-cover rounded-md"><div><p class="font-semibold">${item.name}</p>${item.size ? `<p class="text-sm text-gray-500">Size: ${item.size}</p>` : ''}<button onclick="removeFromCart(${index})" class="text-red-500 text-sm hover:underline">Remove</button></div></div><div class="flex items-center gap-2 md:gap-4"><input type="number" value="${item.quantity}" min="1" class="w-12 md:w-16 text-center border rounded" onchange="updateQuantity(${index}, this.value)"><p class="font-semibold w-20 md:w-24 text-right">৳${(item.price * item.quantity).toLocaleString()}</p></div></div>`).join('');
            const { subtotal } = calculateTotal();
            container.innerHTML = `${itemsHTML}<div class="mt-6 text-right"><p class="text-2xl font-bold">Subtotal: ৳${subtotal.toLocaleString()}</p><a href="#checkout" class="inline-block mt-4 bg-teal-500 text-white py-3 px-8 rounded-lg font-semibold text-lg hover:bg-teal-600 transition">Proceed to Checkout</a></div>`;
        };
        
        const renderCheckoutPage = () => {
            const summaryContainer = document.getElementById('checkout-summary-items');
            if (cart.length === 0) { summaryContainer.innerHTML = `<p class="text-gray-500">Your cart is empty.</p>`; document.getElementById('complete-order-btn').disabled = true; return; }
            document.getElementById('complete-order-btn').disabled = false;
            summaryContainer.innerHTML = cart.map(item => `<div class="flex justify-between items-center"><div class="flex items-center gap-3"><img src="${item.image}" alt="${item.name}" class="w-16 h-16 object-cover rounded"><div><p class="font-semibold">${item.name}</p><p class="text-sm text-gray-500">${item.quantity} x ৳${item.price.toLocaleString()}</p></div></div><p class="font-semibold">৳${(item.price * item.quantity).toLocaleString()}</p></div>`).join('');
            updateCheckoutSummary();
        };

        const updateCheckoutSummary = () => {
            const { subtotal, shipping, total } = calculateTotal();
            document.getElementById('summary-subtotal').textContent = `৳${subtotal.toLocaleString()}`;
            document.getElementById('summary-shipping').textContent = `৳${shipping.toLocaleString()}`;
            document.getElementById('summary-total').textContent = `৳${total.toLocaleString()}`;
        };

        const saveCart = () => localStorage.setItem('sundoricaCart', JSON.stringify(cart));
        window.removeFromCart = (index) => { cart.splice(index, 1); saveCart(); renderCartPage(); updateCartCount(); };
        window.updateQuantity = (index, quantity) => {
            const item = cart[index];
            const productInStore = allProducts.find(p => p.SKU === item.sku);
            let maxQty = 0;
            if (item.size) {
                maxQty = productInStore.Sizes.find(s => s.size === item.size).quantity;
            } else {
                maxQty = productInStore['Available Stock'];
            }
            if (quantity > maxQty) {
                showAlert(`Only ${maxQty} of this item available in stock.`);
                quantity = maxQty;
            }
            cart[index].quantity = parseInt(quantity) || 1; 
            saveCart(); 
            renderCartPage(); 
            updateCartCount();
        };
        document.getElementById('delivery-zone')?.addEventListener('change', updateCheckoutSummary);

        const renderImageGallery = (images) => {
            const mainImage = document.getElementById('main-product-image'), thumbnailContainer = document.getElementById('thumbnail-container');
            thumbnailContainer.innerHTML = '';
            images.forEach((src, index) => {
                const thumb = document.createElement('img');
                thumb.src = src;
                thumb.className = 'thumbnail-img w-20 h-auto md:w-24 md:h-auto object-cover cursor-pointer rounded';
                thumb.onclick = () => { updateMainImage(src, thumb); currentLightboxIndex = index; };
                thumbnailContainer.appendChild(thumb);
            });
            if (images.length > 0) { updateMainImage(images[0], thumbnailContainer.children[0]); currentLightboxIndex = 0; }
        };
        const updateMainImage = (src, activeThumb) => { document.getElementById('main-product-image').src = src; Array.from(document.getElementById('thumbnail-container').children).forEach(c => c.classList.remove('active')); activeThumb.classList.add('active'); };
        
        const openLightbox = (index) => { currentLightboxIndex = index; document.getElementById('lightbox-image').src = selectedProduct.Images[currentLightboxIndex]; document.getElementById('lightbox-modal').classList.remove('hidden'); };
        const closeLightbox = () => document.getElementById('lightbox-modal').classList.add('hidden');
        const showNextImage = () => { currentLightboxIndex = (currentLightboxIndex + 1) % selectedProduct.Images.length; document.getElementById('lightbox-image').src = selectedProduct.Images[currentLightboxIndex]; };
        const showPrevImage = () => { currentLightboxIndex = (currentLightboxIndex - 1 + selectedProduct.Images.length) % selectedProduct.Images.length; document.getElementById('lightbox-image').src = selectedProduct.Images[currentLightboxIndex]; };
        document.getElementById('main-product-image').addEventListener('click', () => openLightbox(currentLightboxIndex));
        document.getElementById('lightbox-close').addEventListener('click', closeLightbox);
        document.getElementById('lightbox-next').addEventListener('click', showNextImage);
        document.getElementById('lightbox-prev').addEventListener('click', showPrevImage);

        const showAlert = (message, isSuccess = false) => {
            const alertPopup = document.getElementById('alert-popup');
            alertPopup.textContent = message;
            alertPopup.className = `fixed top-5 right-5 text-white py-2 px-4 rounded-lg shadow-lg transform transition-transform duration-300 z-[70] ${isSuccess ? 'bg-green-500' : 'bg-red-500'}`;
            alertPopup.classList.remove('translate-x-full');
            setTimeout(() => { alertPopup.classList.add('translate-x-full'); }, 3500);
        };

        document.getElementById('add-to-cart-btn').addEventListener('click', () => {
            if ((selectedProduct.Sizes && selectedProduct.Sizes.length > 0) && !selectedSize) { showAlert('Please select a size.'); return; }
            
            const existingItem = cart.find(item => item.sku === selectedProduct.SKU && item.size === selectedSize);
            const currentQtyInCart = existingItem ? existingItem.quantity : 0;
            
            let maxQty = 0;
            if (selectedSize) {
                maxQty = selectedProduct.Sizes.find(s => s.size === selectedSize).quantity;
            } else {
                maxQty = selectedProduct['Available Stock'];
            }

            if (currentQtyInCart >= maxQty) {
                showAlert('No more stock available for this item.');
                return;
            }

            const newItem = { sku: selectedProduct.SKU, name: selectedProduct.Name, price: selectedProduct.Price, size: selectedSize, quantity: 1, image: selectedProduct.Images[0] };
            if (existingItem) { existingItem.quantity++; } else { cart.push(newItem); }
            saveCart();
            updateCartCount();
            showAlert('Added to cart!', true);
        });

        document.getElementById('buy-now-btn').addEventListener('click', () => {
            if ((selectedProduct.Sizes && selectedProduct.Sizes.length > 0) && !selectedSize) { showAlert('Please select a size.'); return; }
            const newItem = { sku: selectedProduct.SKU, name: selectedProduct.Name, price: selectedProduct.Price, size: selectedSize, quantity: 1, image: selectedProduct.Images[0] };
            cart = [newItem];
            saveCart();
            updateCartCount();
            window.location.hash = '#checkout';
        });

        document.getElementById('checkout-form')?.addEventListener('submit', async (e) => {
            e.preventDefault();
            if (!document.getElementById('delivery-zone').value) { showAlert('Please select a delivery zone.'); return; }
            
            const orderBtn = document.getElementById('complete-order-btn'), btnText = orderBtn.querySelector('.btn-text'), loader = orderBtn.querySelector('.btn-loader');
            orderBtn.disabled = true; btnText.classList.add('hidden'); loader.classList.remove('hidden');

            const { total } = calculateTotal();
            const payload = {
                customer: { name: document.getElementById('name').value, phone: document.getElementById('phone').value, address: document.getElementById('address').value, deliveryCharge: calculateTotal().shipping, totalAmount: total },
                cart: cart.map(item => ({ sku: item.sku, name: item.name, price: item.price, size: item.size, quantity: item.quantity }))
            };

            const formData = new FormData();
            formData.append('orderData', JSON.stringify(payload));

            try {
                const response = await fetch(WEB_APP_URL, { method: 'POST', body: formData });
                if (!response.ok) throw new Error(`Server responded with status: ${response.status}`);
                const result = await response.json();
                if (result.status !== 'success') throw new Error(result.message);
                
                document.getElementById('order-id-display').textContent = result.data.orderId;
                document.getElementById('order-amount-display').textContent = `৳${result.data.totalAmount.toLocaleString()}`;
                document.getElementById('thank-you-modal').classList.remove('hidden');
                localStorage.removeItem('sundoricaProducts');
            } catch (error) {
                console.error("Order submission error:", error);
                showAlert(`Order Failed: ${error.message}`);
            } finally {
                orderBtn.disabled = false; btnText.classList.remove('hidden'); loader.classList.add('hidden');
            }
        });

        document.getElementById('close-thank-you-modal').addEventListener('click', () => {
            document.getElementById('thank-you-modal').classList.add('hidden');
            cart = [];
            saveCart();
            updateCartCount();
            document.getElementById('checkout-form').reset();
            window.location.hash = '#home';
        });
        
        window.handleNav = (event, path) => { event.preventDefault(); window.location.hash = path; };
        window.addEventListener('hashchange', handleRouteChange);
        document.getElementById('mobile-menu-button').addEventListener('click', () => document.getElementById('mobile-menu').classList.toggle('hidden'));
        
        const updateCartCount = () => { document.getElementById('cart-count').textContent = cart.reduce((sum, item) => sum + item.quantity, 0); };
        const calculateTotal = () => {
            const subtotal = cart.reduce((acc, item) => acc + (item.price * item.quantity), 0);
            const deliveryZone = document.getElementById('delivery-zone')?.value;
            let shipping = 0;
            if (deliveryZone) { shipping = parseInt(deliveryZone.split('-').pop()) || 0; }
            return { subtotal, shipping, total: subtotal + shipping };
        };
        
        initializeApp();
    });
    </script>
</body>
</html>
